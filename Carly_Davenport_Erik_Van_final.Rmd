---
title: "Carly Davenport + Erik Van: Final Project"
author: "Carly Davenport, Erik Van"
date: "12/10/2021"
output: html_document
---

# CEE 218X Final Project
## Link to dashboard:

  As we have discussed in class, many urban problems exacerbate the inequalities within an urban system. After over a year and a half of pandemic, Covid-19 still poses a threat to the population’s ability to health, travel, work, and gather, though some are more affected than others. It is no secret that Covid-19 is greatly affecting communities of color and impoverished communities, and these two groups have a lot of overlap. One such community of interest in examining the impact of Covid-19 on vulnerable populations is Oakland, because it contains zip codes with large differences in poverty levels as well as many racially segregated neighborhoods. Oakland is a high impact city to look at because of its large and diverse population. With over 433,000 residents, the city has a relatively equal split between White, Black, and Hispanic/Latino population with a strong Asian presence as well (source 4). In addition, the poverty rate is 16.7%, which is over 5% higher than the national average. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r }
library(tidyverse)
library(sf)
library(tigris)
library(censusapi)
library(mapview)
library(leaflet)
library(tidycensus)
library(StatMatch)

library(geojsonsf)
library(geojson)
library(plotly)
library(httr)
```

  With Oakland’s demographic, Covid-19 has impacted populations in a disproportionate way. One example of this is seen by comparing the zip codes 94603 and 94618, which are on opposite sides of Oakland. Zip code 94603 has 30% of children living below the poverty level and the highest Covid rate in the city whereas  zip code 94618 has  4% of children living below the poverty level and the lowest Covid rate in the city (source 1). Another key insight about this example is that zip code 94618 is 77% White while zip code 94603 is majority Black or African American (source 2).
  Furthermore, at the City of Oakland Racial Disparities Task Force Town Hall it was mentioned that  in Alameda County, Latinx make up 22% of the general population and 46% of the COVID-19 caseload and African-Americans make up 10% of the general population and 14% of COVID-19 cases (source 3). These startling statistics clearly indicate further need to prioritize researching the impact of Covid-19 on the basis of both race and poverty. Local leaders in Oakland have announced how extremely worried they are about these racial disparities in people of color as well as low-income people, immigrants, people with disabilities, and others (source 5).  There are many factors that could also be indicative of Covid-19 impact, risk, and response, so we were also curious to see how the numbers might also relate with covid testing rates, which could alert community members to infection and allow them to take the necessary precautions to avoid further spread. We plan on finding relationships between these variables as well as map them geographically to provide some insights on Covid-19 in Oakland as well as predict future Covid-19 rates. 
  For this reason, we decided to use Census Data for income and race and ArcGIS Hub data that records Alameda County COVID-19 Cases and Case Rates by Zip Code (https://hub.arcgis.com/datasets/5d6bf4760af64db48b6d053e7569a47b_0/explore?location=37.679493%2C-121.905640%2C10.88, https://hub.arcgis.com/datasets/5d6bf4760af64db48b6d053e7569a47b/explore?layer=4&location=37.679103%2C-121.905640%2C10.88 ). 


```{r}
usa_zips <- 
  zctas(cb = T, progress_bar = F)

## Map area of interest: Oakland City in Alameda County
bay_county_names <-
  c(
    "Alameda",
    "Contra Costa",
    "Marin",
    "Napa",
    "San Francisco",
    "San Mateo",
    "Santa Clara",
    "Solano",
    "Sonoma"
  )

bay_counties <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME %in% bay_county_names)

ca_cities <- places("CA", cb = T, progress_bar = FALSE)

bay_cities <- ca_cities[bay_counties, ]

alameda_county <- filter(bay_counties, NAME=="Alameda")

oakland_city <- filter(bay_cities, NAME=="Oakland")

oakland_zips <-
  usa_zips %>% 
  st_centroid() %>% 
  .[oakland_city, ] %>% 
  st_drop_geometry() %>% 
  left_join(usa_zips %>% select(GEOID10)) %>% 
  st_as_sf()

leaflet() %>% 
  addTiles() %>% 
  addPolygons(
    data = alameda_county
  ) %>% 
  addPolygons(
    data = oakland_zips,
    color = "red"
  ) 
```
  Our ultimate goal was to create a dashboard that makes it easy to view Oakland zipcodes in terms of the presence of a chosen income level, race, COVID testing rate, and COVID case rate. Some key insights we hoped to find were **1) how the amount of COVID testing correlates to covid cases (ie. does testing seem to actually have a strong relationship with covid case rate as many say), 2) does access to testing appear equal on the basis of racial or economic background (ie. what does accessibility seem like?) and 3) also evaluating the disparities in Oakland more generally.** One issue to note was that due to having data only as granular as the zipcode level for Oakland, it was not statistically significant to only provide regression data for the variables based on Oakland zipcodes, so our overall analysis of the trends seen in Oakland through our graphs had to be supplemented with regression results for Alameda county, which does add a variable of inconsistency, but we still felt we were able to draw informative conclusions.
Our reflections with specific instances of graphs we wanted to point out are presented below, but the link to our dashboard can be found at the top of this report. 








## COVID Cases and Testing in Alameda and Oakland
 COVID Dataset from Alameda County COVID-19 Case/Case Rates by Zip Code GeoJSON API URL: 
 "https://opendata.arcgis.com/datasets/5d6bf4760af64db48b6d053e7569a47b_0.geojson"

 COVID Dataset from Alameda County COVID-19 Test Rates by Zip Code GeoJSON API URL: 
 "https://opendata.arcgis.com/datasets/5d6bf4760af64db48b6d053e7569a47b_4.geojson"


```{r}
request1 <- GET("https://opendata.arcgis.com/datasets/5d6bf4760af64db48b6d053e7569a47b_0.geojson")
response1 <- content(request1, as = "text", encoding = "UTF-8")
covid_data1 <- as.geojson(response1)
covid_case_data_sf <- geojson_sf(covid_data1)

request2 <- GET("https://opendata.arcgis.com/datasets/5d6bf4760af64db48b6d053e7569a47b_4.geojson")
response2 <- content(request2, as = "text", encoding = "UTF-8")
covid_data2 <- as.geojson(response2)
covid_test_data_sf <- geojson_sf(covid_data2)

# Merge requests
test_rate_tbl <- covid_test_data_sf %>% 
  dplyr::select(Zip_Number, TestRates) %>% 
  st_drop_geometry()

full_covid_data_al <- full_join(covid_case_data_sf, test_rate_tbl, by = "Zip_Number") 
```




```{r}
# Filter covid data to oakland zip codes

covidData_oakland <- full_covid_data_al %>% 
  filter(Zip_Number %in% oakland_zips$ZCTA5CE10) %>% 
  select(c("geometry", "Zip_Number", "CaseRates", "TestRates")) %>%
  mutate(CaseRates = round(CaseRates), 
         TestRates = round(TestRates))
covidData_oakland_drop_geo <- st_drop_geometry(covidData_oakland) 
saveRDS(covidData_oakland, file = "covidData_oakland.rds")
saveRDS(covidData_oakland_drop_geo, file = "covidData_oakland_drop_geo.rds")


#remove extra info from alameda covid data
full_covid_data_al <- full_covid_data_al %>% select(c("geometry", "Zip_Number", "CaseRates", "TestRates")) %>%
  mutate(CaseRates = round(CaseRates), 
         TestRates = round(TestRates))

```



```{r}
# Use census data to map income and race in Oakland
Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")

acs_vars_2019_5yr <-
  listCensusMetadata(
    name = "2019/acs/acs5",
    type = "variables"
  )
```


```{r}
# Get census data by zipcode
census_race_categories <- 
  c(
    "White Alone",
    "Black or African American",
    "American Indian and Alaska Native Alone",
    "Asian Alone",
    "Native Hawaiian and Other Pacific Islander Alone",
    "Some Other Race Alone",
    "Two or More Races"
  )

california_income_race <-
  1:7 %>% 
  map_dfr(function(x){
    getCensus(
      name = "acs/acs5",
      vintage = 2019,
      region = "zip code tabulation area:*",
      regionin = "state:06",
      vars = paste0("group(B19001",LETTERS[x],")")
    ) %>%
      select(zip_code_tabulation_area, !c(GEO_ID,state,NAME) & !ends_with(c("EA","MA","M"))) %>%
      pivot_longer(
        ends_with("E"),
        names_to = "name",
        values_to = "estimate"
      ) %>%
      left_join(
        acs_vars_2019_5yr %>% 
          select(name, label)
      ) %>% 
      select(-name) %>% 
      separate(
        label,
        into = c(NA,NA,"income"),
        sep = "!!"
      ) %>% 
      filter(!is.na(income)) %>% 
      mutate(race = census_race_categories[x])
  })
```


```{r}
#get alameda zipcodes only
alameda_income_race <- california_income_race %>% 
  filter(zip_code_tabulation_area %in% full_covid_data_al$Zip_Number) 

colnames(alameda_income_race)[1] <- "Zip_Number"

#get oakland zipcodes only
oakland_income_race <- california_income_race %>% 
  filter(zip_code_tabulation_area %in% covidData_oakland$Zip_Number)
colnames(oakland_income_race)[1] <- "Zip_Number"
```


```{r}
# Merge Covid and ACS data 
alameda_data <- merge(x = alameda_income_race, y = full_covid_data_al, by = c("Zip_Number")) 

oakland_data <- merge(x = oakland_income_race, y = full_covid_data_al, by = c("Zip_Number")) 

```



## Map of Covid Test Rates in Oakland 

```{r}
covid_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    covidData_oakland$TestRates
)

leaflet() %>%
        addProviderTiles(providers$Stamen.TonerLite) %>% 
        addPolygons(data = covidData_oakland, stroke = TRUE, color = "black", weight = 1, smoothFactor = 0.3,
                    fillOpacity = .7,
                    fillColor = ~covid_pal(covidData_oakland_drop_geo[,3]),
                    highlight = highlightOptions(weight = 5, fillOpacity = 1.0, bringToFront =TRUE),
                    label = paste("Test Rates", covidData_oakland_drop_geo[,3], sep = ": ")) %>%
        addLegend(data = covidData_oakland_drop_geo, title = "Test Rates", pal = covid_pal, 
                  values = covidData_oakland_drop_geo[,3])
```


## Map of Covid Case Rates in Oakland 

```{r}
covid_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    covidData_oakland$CaseRates
)

leaflet() %>%
        addProviderTiles(providers$Stamen.TonerLite) %>% 
        addPolygons(data = covidData_oakland, stroke = TRUE, color = "black", weight = 1, smoothFactor = 0.3,
                    fillOpacity = .7,
                    fillColor = ~covid_pal(covidData_oakland_drop_geo[,2]),
                    highlight = highlightOptions(weight = 5, fillOpacity = 1.0, bringToFront =TRUE),
                    label = paste("Case Rates", covidData_oakland_drop_geo[,2], sep = ": ")) %>%
        addLegend(data = covidData_oakland_drop_geo, title = "Case Rates", pal = covid_pal, 
                  values = covidData_oakland_drop_geo[,2])
```
      



# Equity analysis of income and race in Oakland
```{r}
oakland_race_total <-
  oakland_income_race %>% 
  group_by(race) %>% 
  summarize(estimate = sum(estimate)) %>% 
  mutate(income = "Total")

oakland_income_total <-
  oakland_income_race %>% 
  group_by(income) %>% 
  summarize(estimate = sum(estimate)) %>% 
  mutate(income = "Total")

oakland_income_race %>% 
  group_by(income, race) %>% 
  summarize(estimate = sum(estimate)) %>% 
  rbind(oakland_race_total) %>% 
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total",unique(oakland_income_race$income)))),
      y = estimate,
      fill = race %>% factor(levels = rev(unique(oakland_income_race$race)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Proportion of households",
    title = "Oakland household income by race",
    fill = "Race of householder"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```

## Assumptions about the above graph: 

 My first major assumption is that the breakdown of race in this visual is representative of the breakdown of population in Oakland. Another assumption is the validity, completeness, and accuracy of the data set used. This data set is gathered and produced by the US Census, so we are assuming it is from a credible source on the topic and was gathered in a fair and unbiased way.

## Examples of interesting plots and findings from our dashboard

```{r}
     oakland_target_race_by_zip <- oakland_data %>% 
       select(Zip_Number, estimate, race) %>%
       group_by(Zip_Number, race) %>%
       mutate(Zip_Number = as.numeric(Zip_Number)) %>%
       summarize(estimate = sum(estimate)) %>%
      filter(race == "Black or African American") %>%
        select(-race) 
      
      oakland_target_race_by_zip_sf <- oakland_target_race_by_zip %>% 
      left_join(
        usa_zips %>%
          transmute(GEOID10 = as.numeric(GEOID10)),
        by = c("Zip_Number" = "GEOID10")
        ) %>%
      st_as_sf()

    race_pal <- colorNumeric(
      palette = "Reds",
      domain = oakland_target_race_by_zip_sf$oakland_target_race_by_zip
      )

      leaflet() %>%
      addProviderTiles(providers$CartoDB.Positron) %>%
      addPolygons(
        data = oakland_target_race_by_zip_sf,
        fillColor = ~race_pal(oakland_target_race_by_zip$estimate),
        color = "white",
        weight = 0.5,
        fillOpacity = 0.5,
        label = ~oakland_target_race_by_zip$estimate
        ) %>%
      addLegend(
        data = oakland_target_race_by_zip_sf,
        pal = race_pal,
        values = ~oakland_target_race_by_zip$estimate,
        title = "Breakdown of population in Oakland"
        )
```



## Regression Modeling 

 We noticed that when trying to see the relationship of COVID cases versus COVID testing that outliers were present and make the results less relevant, so we wanted to find which zipcodes caused these outliers and removed them to allow the results to be more accurate
```{r}

#NOTE: ignore estimates if not for income or race group
alameda_grouping_by_zip1 <-
  alameda_data %>% 
  #select(-income) %>%
  group_by(Zip_Number, TestRates, CaseRates) %>%
  summarize(estimate = sum(estimate))



```


```{r}

covid_data_plot1 <- ggplot(
  data = alameda_grouping_by_zip1,
  aes(
      x = TestRates,
      y = CaseRates
    )
) +
  geom_point() +
  geom_smooth(method = "lm") 

covid_data_plot1 %>% ggplotly()

model <- lm(CaseRates ~ TestRates, alameda_grouping_by_zip1)

summary(model)




```
 From this we can identify there are some zipcodes with data points that deviate far from the rest of the data points, specifically 94720, 95377, 94621,94613 and 94603, so we will remove these frames from the regression to help improve it

```{r}
alameda_grouping_by_zip1 <-
  alameda_data %>% 
  group_by(Zip_Number, TestRates, CaseRates) %>%
  summarize(estimate = sum(estimate))  %>%
  filter(!(Zip_Number %in% c(94720,95377, 94621,94603,94613)))


covid_data_plot1 <- ggplot(
  data = alameda_grouping_by_zip1,
  aes(
      x = TestRates,
      y = CaseRates
    )
) +
  geom_point() +
  geom_smooth(method = "lm") 

covid_data_plot1 %>% ggplotly()





```


```{r}
model <- lm(CaseRates ~ TestRates, alameda_grouping_by_zip1)

summary(model)

```
As we can see, removing the outliers changed the trend of the graph, and so now we are ready for analysis. 



```{r}
alameda_grouping_by_zip2 <-
  alameda_data %>% 
  group_by(Zip_Number, income, CaseRates) %>%
  summarize(estimate = sum(estimate))  %>%
  filter(income == "$10,000 to $14,999") %>%
  filter(!(Zip_Number %in% c(94720,95377, 94621,94603,94613)))

covid_data_plot2 <- ggplot(
  data = alameda_grouping_by_zip2,
  aes(
      x = estimate,
      y = CaseRates
    )
) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(
    x = "People with annual household income $10,000 to $14,999",
    y = "CaseRates",
    title = paste0(" Alameda County Linear Regression of Case Rates and <br> People with annual household income $10,000 to $14,999")
  )

covid_data_plot2 %>% ggplotly()

```

```{r}

model <- lm(estimate ~ CaseRates, alameda_grouping_by_zip2)

summary(model)

```


Sources: 
https://calmatters.org/health/coronavirus/2021/06/california-covid-inequality-oakland-rockridge/ 
https://www.unitedstateszipcodes.org/
https://www.accfb.org/how-covid-19-is-affecting-communities-of-color/ 
https://www.census.gov/quickfacts/oaklandcitycalifornia
https://www.oaklandca.gov/news/2020/local-leaders-announce-covid-19-racial-disparities-task-force


