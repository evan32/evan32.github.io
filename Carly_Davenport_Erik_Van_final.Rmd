---
title: "Carly Davenport + Erik Van: Final Project"
author: "Carly Davenport, Erik Van"
date: "12/10/2021"
output: html_document
---

# CEE 218X Final Project

## Key questions:

### What is the relationship between poverty, race, covid rates, and covid testing rates? How do only comparing two of these variables versus all three together change the trend/relationship we see?

#### What is the relationship between race, covid rates, and covid testing rates? How do only comparing two of these variables versus all three together change the trend/relationship we see?

#### Geographically, how does covid rates and testing map across the city of Oakland? What key insights can be drawn from this mapping? 

### General Notes for soft submission: We worked on pulling and formatting the data we needed for our project and made some preliminary graphs (though we plan to include more + analysis of results). Realizing that our covid data is in terms of zipcodes and our other census data is in terms of census tracts, we will have to stick to just using some side-by-side analysis to draw certain conclusion, but we still hope that the results can be informative (and ideally in a convenient dashboard format) 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r }
library(tidyverse)
library(sf)
library(tigris)
library(censusapi)
library(mapview)
library(leaflet)
library(tidycensus)
library(StatMatch)

library(geojsonsf)
library(geojson)
library(plotly)
library(httr)
```

```{r}
usa_zips <- 
  zctas(cb = T, progress_bar = F)

## Map area of interest: Oakland City in Alameda County
bay_county_names <-
  c(
    "Alameda",
    "Contra Costa",
    "Marin",
    "Napa",
    "San Francisco",
    "San Mateo",
    "Santa Clara",
    "Solano",
    "Sonoma"
  )

bay_counties <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME %in% bay_county_names)

ca_cities <- places("CA", cb = T, progress_bar = FALSE)

bay_cities <- ca_cities[bay_counties, ]

alameda_county <- filter(bay_counties, NAME=="Alameda")

oakland_city <- filter(bay_cities, NAME=="Oakland")

oakland_zips <-
  usa_zips %>% 
  st_centroid() %>% 
  .[oakland_city, ] %>% 
  st_drop_geometry() %>% 
  left_join(usa_zips %>% select(GEOID10)) %>% 
  st_as_sf()

leaflet() %>% 
  addTiles() %>% 
  addPolygons(
    data = alameda_county
  ) %>% 
  addPolygons(
    data = oakland_zips,
    color = "red"
  ) 
```








## COVID Cases and Testing in Alameda and Oakland
 COVID Dataset from Alameda County COVID-19 Case/Case Rates by Zip Code GeoJSON API URL: 
 "https://opendata.arcgis.com/datasets/5d6bf4760af64db48b6d053e7569a47b_0.geojson"

 COVID Dataset from Alameda County COVID-19 Test Rates by Zip Code GeoJSON API URL: 
 "https://opendata.arcgis.com/datasets/5d6bf4760af64db48b6d053e7569a47b_4.geojson"


```{r}
request1 <- GET("https://opendata.arcgis.com/datasets/5d6bf4760af64db48b6d053e7569a47b_0.geojson")
response1 <- content(request1, as = "text", encoding = "UTF-8")
covid_data1 <- as.geojson(response1)
covid_case_data_sf <- geojson_sf(covid_data1)

request2 <- GET("https://opendata.arcgis.com/datasets/5d6bf4760af64db48b6d053e7569a47b_4.geojson")
response2 <- content(request2, as = "text", encoding = "UTF-8")
covid_data2 <- as.geojson(response2)
covid_test_data_sf <- geojson_sf(covid_data2)

# Merge requests
test_rate_tbl <- covid_test_data_sf %>% 
  dplyr::select(Zip_Number, TestRates) %>% 
  st_drop_geometry()

full_covid_data_al <- full_join(covid_case_data_sf, test_rate_tbl, by = "Zip_Number") 
```


### Filter covid data to oakland zip codes

```{r}
covidData_oakland <- full_covid_data_al %>% 
  filter(Zip_Number %in% oakland_zips$ZCTA5CE10) %>% 
  select(c("geometry", "Zip_Number", "CaseRates", "TestRates")) %>%
  mutate(CaseRates = round(CaseRates), 
         TestRates = round(TestRates))
covidData_oakland_drop_geo <- st_drop_geometry(covidData_oakland) 


#remove extra info from alameda covid data
full_covid_data_al <- full_covid_data_al %>% select(c("geometry", "Zip_Number", "CaseRates", "TestRates")) %>%
  mutate(CaseRates = round(CaseRates), 
         TestRates = round(TestRates))

```


## Using census data to map income and race in Oakland
```{r}
Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")

acs_vars_2019_5yr <-
  listCensusMetadata(
    name = "2019/acs/acs5",
    type = "variables"
  )
```

# Get census data by zipcode
```{r}
census_race_categories <- 
  c(
    "White Alone",
    "Black or African American",
    "American Indian and Alaska Native Alone",
    "Asian Alone",
    "Native Hawaiian and Other Pacific Islander Alone",
    "Some Other Race Alone",
    "Two or More Races"
  )

california_income_race <-
  1:7 %>% 
  map_dfr(function(x){
    getCensus(
      name = "acs/acs5",
      vintage = 2019,
      region = "zip code tabulation area:*",
      regionin = "state:06",
      vars = paste0("group(B19001",LETTERS[x],")")
    ) %>%
      select(zip_code_tabulation_area, !c(GEO_ID,state,NAME) & !ends_with(c("EA","MA","M"))) %>%
      pivot_longer(
        ends_with("E"),
        names_to = "name",
        values_to = "estimate"
      ) %>%
      left_join(
        acs_vars_2019_5yr %>% 
          select(name, label)
      ) %>% 
      select(-name) %>% 
      separate(
        label,
        into = c(NA,NA,"income"),
        sep = "!!"
      ) %>% 
      filter(!is.na(income)) %>% 
      mutate(race = census_race_categories[x])
  })
```


```{r}
#get alameda zipcodes only
alameda_income_race <- california_income_race %>% 
  filter(zip_code_tabulation_area %in% full_covid_data_al$Zip_Number) 

colnames(alameda_income_race)[1] <- "Zip_Number"

#get oakland zipcodes only
oakland_income_race <- california_income_race %>% 
  filter(zip_code_tabulation_area %in% covidData_oakland$Zip_Number)
colnames(oakland_income_race)[1] <- "Zip_Number"
```
### Merge Covid and ACS data 

```{r}
alameda_data <- merge(x = alameda_income_race, y = full_covid_data_al, by = c("Zip_Number")) 

oakland_data <- merge(x = oakland_income_race, y = full_covid_data_al, by = c("Zip_Number")) 

```



## Map of Covid Test Rates in Oakland 

```{r}
covid_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    covidData_oakland$TestRates
)

leaflet() %>%
        addProviderTiles(providers$Stamen.TonerLite) %>% 
        addPolygons(data = covidData_oakland, stroke = TRUE, color = "black", weight = 1, smoothFactor = 0.3,
                    fillOpacity = .7,
                    fillColor = ~covid_pal(covidData_oakland_drop_geo[,3]),
                    highlight = highlightOptions(weight = 5, fillOpacity = 1.0, bringToFront =TRUE),
                    label = paste("Test Rates", covidData_oakland_drop_geo[,3], sep = ": ")) %>%
        addLegend(data = covidData_oakland_drop_geo, title = "Test Rates", pal = covid_pal, 
                  values = covidData_oakland_drop_geo[,3])
```


## Map of Covid Case Rates in Oakland 

```{r}
covid_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    covidData_oakland$TestRates
)

leaflet() %>%
        addProviderTiles(providers$Stamen.TonerLite) %>% 
        addPolygons(data = covidData_oakland, stroke = TRUE, color = "black", weight = 1, smoothFactor = 0.3,
                    fillOpacity = .7,
                    fillColor = ~covid_pal(covidData_oakland_drop_geo[,2]),
                    highlight = highlightOptions(weight = 5, fillOpacity = 1.0, bringToFront =TRUE),
                    label = paste("Case Rates", covidData_oakland_drop_geo[,2], sep = ": ")) %>%
        addLegend(data = covidData_oakland_drop_geo, title = "Case Rates", pal = covid_pal, 
                  values = covidData_oakland_drop_geo[,2])
```
      
```


## Equity analysis of income and race in Oakland
```{r}
oakland_race_total <-
  oakland_income_race %>% 
  group_by(race) %>% 
  summarize(estimate = sum(estimate)) %>% 
  mutate(income = "Total")

oakland_income_total <-
  oakland_income_race %>% 
  group_by(income) %>% 
  summarize(estimate = sum(estimate)) %>% 
  mutate(income = "Total")

oakland_income_race %>% 
  group_by(income, race) %>% 
  summarize(estimate = sum(estimate)) %>% 
  rbind(oakland_race_total) %>% 
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total",unique(oakland_income_race$income)))),
      y = estimate,
      fill = race %>% factor(levels = rev(unique(oakland_income_race$race)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Proportion of households",
    title = "Oakland household income by race",
    fill = "Race of householder"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```

### Assumptions about above graph: 

### My first major assumption is that the breakdown of race in this visual is representative of the breakdown of population in Oakland. Another assumption is the validity, completeness, and accuracy of the data set used. This data set is gathered and produced by the US Census, so we are assuming it is from a credible source on the topic and was gathered in a fair and unbiased way.

## Example how to plot for our dashboard

```{r}
     oakland_target_race_by_zip <- oakland_data %>% 
       select(Zip_Number, estimate, race) %>%
       group_by(Zip_Number, race) %>%
       mutate(Zip_Number = as.numeric(Zip_Number)) %>%
       summarize(estimate = sum(estimate)) %>%
      filter(race == "Black or African American") %>%
        select(-race) 
      
      oakland_target_race_by_zip_sf <- oakland_target_race_by_zip %>% 
      left_join(
        usa_zips %>%
          transmute(GEOID10 = as.numeric(GEOID10)),
        by = c("Zip_Number" = "GEOID10")
        ) %>%
      st_as_sf()

    race_pal <- colorNumeric(
      palette = "Reds",
      domain = oakland_target_race_by_zip_sf$oakland_target_race_by_zip
      )

      leaflet() %>%
      addProviderTiles(providers$CartoDB.Positron) %>%
      addPolygons(
        data = oakland_target_race_by_zip_sf,
        fillColor = ~race_pal(oakland_target_race_by_zip$estimate),
        color = "white",
        weight = 0.5,
        fillOpacity = 0.5,
        label = ~oakland_target_race_by_zip$estimate
        ) %>%
      addLegend(
        data = oakland_target_race_by_zip_sf,
        pal = race_pal,
        values = ~oakland_target_race_by_zip$estimate,
        title = "Breakdown of population in Oakland"
        )
```



## Findings based on the above maps:

 The city of Oakland is an interesting case study because it is made up of zip codes with large differences in poverty levels as well as many racially segregated neighborhoods. This situation allows us to visualize the impact of Covid-19 on different populations. 

 Comparing the map of Covid test with the map of White and Black populations, it looks like the zipcode with the most test rates is also the zipcode with a high white population as well as a high population of highest income people. The rest of Oakland has roughly the same testing rates.

 Comparing the map of Covid case with the map of White and Black populations, it looks like the zipcode with the most case rates is also the zipcode with a high white population with a relatively lower income population. The lowest covid case rates are in the zipcodes with the highest test rates, which are the population that is mostly white and high income. 

 These preliminary findings are only looking at the highest/lowest income population as well only as white and black people. The population of Oakland is a lot more diverse than that so further investigation is needed. 


## Regression Modeling - REDO WITH ALAMEDA COUNTY 

# Covid cases versus testing(with outliers)
```{r}

#NOTE: ignore estimates if not for income or race group
alameda_grouping_by_zip1 <-
  alameda_data %>% 
  #select(-income) %>%
  group_by(Zip_Number, TestRates, CaseRates) %>%
  summarize(estimate = sum(estimate))



```
#removing outliers based on the relationship between covid rate and covid test rate

```{r}

covid_data_plot1 <- ggplot(
  data = alameda_grouping_by_zip1,
  aes(
      x = TestRates,
      y = CaseRates
    )
) +
  geom_point() +
  geom_smooth(method = "lm") 

covid_data_plot1 %>% ggplotly()

model <- lm(CaseRates ~ TestRates, alameda_grouping_by_zip1)

summary(model)




```
# From this we can identify there are some zipcodes with data points that deviate far from the rest of the data points, specifically 94720, 95377, 94621,94613 and 94603, so we will remove these frames from the regression to help improve it

```{r}
alameda_grouping_by_zip1 <-
  alameda_data %>% 
  group_by(Zip_Number, TestRates, CaseRates) %>%
  summarize(estimate = sum(estimate))  %>%
  filter(!(Zip_Number %in% c(94720,95377, 94621,94603,94613)))


covid_data_plot1 <- ggplot(
  data = alameda_grouping_by_zip1,
  aes(
      x = TestRates,
      y = CaseRates
    )
) +
  geom_point() +
  geom_smooth(method = "lm") 

covid_data_plot1 %>% ggplotly()





```


```{r}
model <- lm(CaseRates ~ TestRates, alameda_grouping_by_zip1)

summary(model)

```




```{r}
alameda_grouping_by_zip2 <-
  alameda_data %>% 
  group_by(Zip_Number, income, CaseRates) %>%
  summarize(estimate = sum(estimate))  %>%
  filter(income == "$10,000 to $14,999") %>%
  filter(!(Zip_Number %in% c(94720,95377, 94621,94603,94613)))

covid_data_plot2 <- ggplot(
  data = alameda_grouping_by_zip2,
  aes(
      x = CaseRates,
      y = estimate
    )
) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(
    x = "CaseRates",
    y = "People with annual household income $10,000 to $14,999",
    title = paste0(" Alameda County Linear Regression of Case Rates and <br> People with annual household income $10,000 to $14,999")
  )

covid_data_plot2 %>% ggplotly()

```

```{r}

model <- lm(estimate ~ CaseRates, alameda_grouping_by_zip2)

summary(model)

```


