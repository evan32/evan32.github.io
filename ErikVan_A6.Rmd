---
title: "ErikVan_A6"
author: "Erik Van"
date: " 11/2/2021"
output: html_document
---

# CEE 218X Assignment 6 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```


```{r}
library(censusapi)
library(tidyverse)
library(tigris)
library(sf)
library(leaflet)

Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")
```



```{r}
pums_2019_1yr <- getCensus(
  name = "acs/acs1/pums",
  vintage = 2019,
  region = "public use microdata area:*", 
  regionin = "state:06",
  vars = c(
    "SERIALNO",
    "SPORDER",
    "PWGTP",
    "WGTP",
    "HHL",
    "YBL", 
    "BLD", 
    "TEN", 
    "MV", 
    "HINCP",
    "AGEP"
  )
)
```



```{r}
ca_pumas <-
  pumas("CA", cb = T, progress_bar = F)

sf_boundary <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME == "San Francisco")

sf_pumas <-
  ca_pumas %>% 
  st_centroid() %>% 
  .[sf_boundary, ] %>% 
  st_drop_geometry() %>% 
  left_join(ca_pumas %>% select(GEOID10)) %>% 
  st_as_sf()

sf_pums <-
  pums_2019_1yr %>% 
  mutate(
    PUMA = str_pad(public_use_microdata_area,5,"left","0")
  ) %>% 
  filter(PUMA %in% sf_pumas$PUMACE10)

sf_pums_clean <- sf_pums %>%
  mutate(
    YBL = as.numeric(YBL), 
    AGEP = as.numeric(AGEP),
    HINCP = as.numeric(HINCP)
  ) %>%
  filter(YBL %in% 1:3) %>%
  arrange(AGEP) %>%
  group_by(SERIALNO) %>%
  summarize_all(first)
  
```

### Map View of San Francisco PUMAs. 
#### Three strange geographic anomalies: 1. uninhabited island in the middle of the water 2. Fragments of Angel island and Alameda 3. Treasure Island 

```{r}
library(mapview)
mapview(sf_pumas)
```



```{r}
sf_pums_leadrisk <-
  sf_pums_clean %>% 
  mutate(
    leadrisk = ifelse(
      (HINCP < 90000) & (AGEP < 6) ,
      1,
      0
    )
  )
```

```{r}
sf_pums_factors <- sf_pums_leadrisk %>% 
  mutate(
    building = BLD %>% 
      factor(
        levels = sf_pums_leadrisk$BLD %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ) 
    ) %>% 
  mutate(
    tenure = TEN %>% 
      factor(
        levels = sf_pums_leadrisk$TEN %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ) 
    ) %>% 
  mutate(
    move = MV %>% 
      factor(
        levels = sf_pums_leadrisk$MV %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ) 
    ) %>% 
    mutate(
    areacode = PUMA %>% 
      factor(
        levels = sf_pums_leadrisk$PUMA %>% 
          unique() %>%
          sort()
      ) 
    ) 
```

### Summary of glm model

```{r}
logit_model <- glm(
  leadrisk ~ building + tenure + move + areacode,
  family = quasibinomial(),
  data = sf_pums_factors
)

summary(logit_model)
```

### Results of: exp(coef(logit_model))/(exp(coef(logit_model))+1)
```{r}
exp(coef(logit_model))/(exp(coef(logit_model))+1)
```


### Using sample_n() to supply this one-row dataframe inside of predict()

### Print sample from sample_n()

```{r}
test_sample = sample_n(sf_pums_factors, 1)
print(test_sample)
```

### Using predict()
```{r}
predict(logit_model, test_sample, type = "response")
```

 
##### [Code Hidden] Below is my attempt for 6.5 points on the assignment; however, I was unable to finish it 

```{r}
# library(survey)
# 
# pums_2019_1yr_wts <- getCensus(
#   name = "acs/acs1/pums",
#   vintage = 2019,
#   region = "public use microdata area:*", 
#   regionin = "state:06",
#   vars = c(
#     paste0("PWGTP",1:80)
#   )
# ) %>% 
#   mutate(
#     PUMA = str_pad(public_use_microdata_area,5,"left","0")
#   ) %>% 
#   filter(PUMA %in% sf_pumas$PUMACE10)
# 
# bay_pums_language_wts <- pums_2019_1yr_wts %>% 
#   mutate(AGEP = sf_pums$AGEP) %>% 
#   filter(as.numeric(AGEP) >= 5) %>% 
#   select(starts_with("PWGTP"))
```
  
  
```{r}
# sample <- sample(
#  c(TRUE, FALSE), 
#  nrow(sf_pums_factors), 
#  replace = T, 
#  prob = c(0.8,0.2)
# )
#  
# train <- sf_pums_factors[sample, ]
# test <- sf_pums_factors[!sample, ]
# ```
# 
# ```{r}
# train_design <- svrepdesign(
#   data = train,
#   type = "ACS",
#   repweights = bay_pums_language_wts[sample, ],
#   weights = ~as.numeric(PWGTP)
#  )
#  
# train_model <- svyglm(
#  leadrisk ~ building + tenure + move + areacode,
#  family = quasibinomial(),
#  design = train_design,
#  )
```
 
```{r}
#  summary(train_model)
```
 
 
```{r}
#  test_predicted <-
#   predict(train_model, newdata = test, type = "response")
```
 
 
```{r}
# summary_2x2 <-
#   test %>% 
#   mutate(
#     leadrisk = ifelse(
#       leadrisk == 1, 
#        "Yes", 
#        "No"
#      )
#    ) %>%  
#   pull(leadrisk) %>% 
# table(test_predicted > 0.5)
```




