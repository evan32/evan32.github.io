---
title: "ErikVan_A1"
author: "Erik Van"
date: "9/28/2021"
output: html_document
---

# CEE 218X Assignment 1 

## The following is the output of loading the packages and parsing the PG&E data to analyze 2017-2021 data. 

 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```

```{r}
library(tidyverse)

years <- 2017:2021
quarters <- 1:4
types <- c("Electric", "Gas")

pge_20 <- NULL

for (type in types) {
  for (year in years) {
    for(quarter in quarters) {
      if ((year != 2021) | (quarter != 3 & quarter != 4)) {
  
        filename <- 
          paste0(
            "pge/PGE_",
            year,
            "_Q",
            quarter,
            "_",
            type,
            "UsageByZip.csv"
          )

        print(filename)
  
        temp <- read_csv(filename)
        
        if (type == "Electric") {
          temp_mutate <- 
            temp %>%
            filter(
              CUSTOMERCLASS %in% 
                c(
                  "Elec- Residential",
                  "Elec- Commercial"
                )
            ) %>% 
            mutate(
              TOTALKBTU = TOTALKWH*3.41214,
              AVERAGEKBTU = AVERAGEKWH*3.41214
            ) %>%
           select(
             -c(COMBINED, TOTALKWH, AVERAGEKWH)
            )
        }
        
        if (type == "Gas") {
          temp_mutate <- 
            temp %>%
            filter(
              CUSTOMERCLASS %in% 
                c(
                  "Gas- Residential",
                  "Gas- Commercial"
                )
            ) %>% 
            mutate(
              TOTALKBTU = TOTALTHM*99.9761,
              AVERAGEKBTU = AVERAGETHM*99.9761
            ) %>%
           select(
             -c(COMBINED, TOTALTHM, AVERAGETHM)
            )
        }
        

        pge_20 <- rbind(pge_20,temp_mutate)
      # Note rbind requires field names to be consistent for every new thing that you add.
        saveRDS(pge_20, "pge_20.rds")
      }
    }
  }
}
```


```{r}

pge_final <-
  pge_20 %>% 
  select(
    -c(AVERAGEKBTU)
  ) %>% 
  group_by(MONTH, YEAR, CUSTOMERCLASS) %>% 
  summarize(
    TOTALKBTU = 
      sum(
        TOTALKBTU, 
        na.rm = T
      ),
    TOTALCUSTOMERS =
      sum(
        TOTALCUSTOMERS,
        na.rm = T
      )
  ) %>% 
  mutate(
    AVERAGEKBTU = TOTALKBTU/TOTALCUSTOMERS
  )

pge_final_date <-
  pge_final %>% 
  mutate(
    DATE = as.Date(
      paste0(
        YEAR, "-", MONTH, "-", "01"
      )
    )
  ) 
```


```{r}
pge_final_residential <-
  pge_final_date %>% 
  filter(
    CUSTOMERCLASS %in% 
      c(
        "Elec- Residential",
        "Gas- Residential"
        )
    ) 
```

```{r}
pge_final_commercial <-
  pge_final_date %>% 
  filter(
    CUSTOMERCLASS %in% 
      c(
        "Elec- Commercial",
        "Gas- Commercial"
        )
    ) 
```

```{r}
library(tidyverse)
library(plotly)

pge_chart_residential <-
  pge_final_residential %>% 
  ggplot() +
  geom_bar(
    aes(
      x = DATE,
      y = TOTALKBTU,
      fill = CUSTOMERCLASS
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    x = "DATE (MONTH/YEAR)",
    y = "kBTUs",
    title = "PG&E Territory Residential Monthly Electricity and Gas Usage 2017-2021",
    fill = "Utility Type"
  )
```

## The following are the graphs of PG&E data between 2017 and 2021. 

```{r}
pge_chart_residential
```
```{r}
library(tidyverse)
library(plotly)

pge_chart_commercial <-
  pge_final_commercial %>% 
  ggplot() +
  geom_bar(
    aes(
      x = DATE,
      y = TOTALKBTU,
      fill = CUSTOMERCLASS
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    x = "DATE (MONTH/YEAR)",
    y = "kBTUs",
    title = "PG&E Territory Commercial Monthly Electricity and Gas Usage 2017-2021",
    fill = "Utility Type"
  )
```

```{r}
pge_chart_commercial
```


## The following is the output of loading the packages and parsing the PG&E data to analayze 2019-2020 data. 

```{r}
years <- 2019:2020
quarters <- 1:4
types <- c("Electric", "Gas")

pge_19_20 <- NULL

for (type in types) {
  for (year in years) {
    for(quarter in quarters) {
      if ((year != 2021) | (quarter != 3 & quarter != 4)) {
  
        filename <- 
          paste0(
            "pge/PGE_",
            year,
            "_Q",
            quarter,
            "_",
            type,
            "UsageByZip.csv"
          )

        print(filename)
  
        temp <- read_csv(filename)
        
        if (type == "Electric") {
          temp_mutate <- 
            temp %>%
            filter(
              CUSTOMERCLASS %in% 
                c(
                  "Elec- Residential",
                  "Elec- Commercial"
                )
            ) %>% 
            mutate(
              TOTALKBTU = TOTALKWH*3.41214,
              AVERAGEKBTU = AVERAGEKWH*3.41214
            ) %>%
           select(
             -c(COMBINED, TOTALKWH, AVERAGEKWH)
            )
        }
        
        if (type == "Gas") {
          temp_mutate <- 
            temp %>%
            filter(
              CUSTOMERCLASS %in% 
                c(
                  "Gas- Residential",
                  "Gas- Commercial"
                )
            ) %>% 
            mutate(
              TOTALKBTU = TOTALTHM*99.9761,
              AVERAGEKBTU = AVERAGETHM*99.9761
            ) %>%
           select(
             -c(COMBINED, TOTALTHM, AVERAGETHM)
            )
        }
        
        pge_19_20 <- rbind(pge_19_20,temp_mutate)
      # Note rbind requires field names to be consistent for every new thing that you add.
        saveRDS(pge_19_20, "pge_19_20.rds")
      }
    }
  }
}

pge_final_19_20 <-
  pge_19_20 %>% 
  select(
    -c(AVERAGEKBTU)
  ) %>% 
  group_by(MONTH, YEAR, CUSTOMERCLASS) %>% 
  summarize(
    TOTALKBTU = 
      sum(
        TOTALKBTU, 
        na.rm = T
      ),
    TOTALCUSTOMERS =
      sum(
        TOTALCUSTOMERS,
        na.rm = T
      )
  ) %>% 
  mutate(
    AVERAGEKBTU = TOTALKBTU/TOTALCUSTOMERS
  )

pge_final_19_20_date <-
  pge_final_19_20 %>% 
  mutate(
    DATE = as.Date(
      paste0(
        YEAR, "-", MONTH, "-", "01"
      )
    )
  ) 

pge_final_19_20_residential <-
  pge_final_19_20_date %>% 
  filter(
    CUSTOMERCLASS %in% 
      c(
        "Elec- Residential",
        "Gas- Residential"
        )
    ) 

pge_final_19_20_commercial <-
  pge_final_19_20_date %>% 
  filter(
    CUSTOMERCLASS %in% 
      c(
        "Elec- Commercial",
        "Gas- Commercial"
        )
    ) 
```

```{r}
library(tidyverse)
library(plotly)

pge_chart_19_20_residential <-
  pge_final_19_20_residential %>% 
  ggplot() +
  geom_bar(
    aes(
      x = DATE,
      y = TOTALKBTU,
      fill = CUSTOMERCLASS
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    x = "DATE (MONTH/YEAR)",
    y = "kBTUs",
    title = "PG&E Territory Residential Monthly Electricity and Gas Usage 2019-2020",
    fill = "Utility Type"
  )
```

## The following are the graphs of PG&E data between 2019 and 2020. 


```{r}
pge_chart_19_20_residential
```

```{r}
library(tidyverse)
library(plotly)

pge_chart_19_20_commercial <-
  pge_final_19_20_commercial %>% 
  ggplot() +
  geom_bar(
    aes(
      x = DATE,
      y = TOTALKBTU,
      fill = CUSTOMERCLASS
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    x = "DATE (MONTH/YEAR)",
    y = "kBTUs",
    title = "PG&E Territory Commercial Monthly Electricity and Gas Usage 2019-2020",
    fill = "Utility Type"
  )
```

```{r}
pge_chart_19_20_commercial
```


## Prompt: 
Comment on any observable changes in energy consumption that may be attributable to the COVID-19 pandemic (you are encouraged to create additional plots that help emphasize the change between 2019 and 2020). Explain any key assumptions you made in the analysis, or caveats about the data sources that you think the reader should be aware of. 


## Answer: 
The most noticeable energy consumption change between 2019 and 2020 is the drop in commercial electricity usage. Relative to the corresponding month in 2019, the montly usage in 2020 fell on average approximately .2e^10 kBTUs. This is most likely due to the switch to remote working so there is less commercial electricity being used. In addition, commercial gas also fell but not as drastically as commercial electricity. Residential gas and electricity fluctuated a little between 2019 and 2020 but stayed mostly consistent between the two years- the fluctuation accounts for a slight increase in residential electricity; this is consistent with the working remotely explanation as people are spending more time in their residential environment. 

 
## Key Assumptions: 
An assumption is the correct conversion precision between kWhs to kBTUs and therms to kBTUs. The original data set used kWhs for electricity and therms for gas. In this analysis, the kWhs to kBTUs conversion was 1 to 3.41214 and the therms to kBTUs was 1 to 99.9761. Another assumption is the validity, completeness, and accuracy of the data set used. This data set is gathered and produced by PG&E so we are assuming it is from a credible source on the topic and was gathered in a fair and unbiased way. 